# Hyperlane integration proof-of-concept

Example of an integration of hyperlane with Espresso.

# Development environment

Everytime you open a terminal run

```bash
> ./launch_shell
```

# AWS configuration

The validator and the relayer use AWS services.

## Create IAM user

Reference: https://docs.hyperlane.xyz/docs/operate/set-up-agent-keys#2-aws-kms

1. Go to [aws.amazon.com](aws.amazon.com) and login.
1. Go to AWS's Identity and Access Management (IAM)
1. On the left, under "Access management", click "Policies".
1. Click "Create policy"
1. In the tab "Policy editor" click "JSON"
1. Copy the content of `aws/user-policy.json` inside the editor.
1. Click "Next".
1. Add a policy name (Field below "Policy details"), e.g "hyperlane-policy-XYZ"
1. Click create policy.
1. Go back to IAM home page 
1. On the left, under "Access management", click "Users".
1. Click the orange button "Create users".
1. Pick a friendly and informative username, like *hyperlane1*. 
1. Select "Attach policies directly". 
1. Select the policy you create above using the name, e.g. "hyperlane-policy-XYZ".
1. Click on "Create user"
1. Click on the user you created.
1. Click on "Security credentials"
1. Scroll down to "Access Keys" and click on "Create Access Key"
1. Select "Application running outside AWS" and click "Next"
1. Click "Next", no need to add a description tag
1. Click "Create access key"
1. Copy the "Access key ID" and "Secret access key" to a safe place.
1. Go to the IAM home and copy the Account ID (see panel "AWS Account" at the top right)
1. Identify your AWS region: Check at the beginning of the url e.g.: https://us-east-1.console.aws.amazon means your region is us-east-1.
    
Set the following environment variables:

```bash
export AWS_USER_NAME=<Copy the name chosen in step 5>
export AWS_ACCESS_KEY_ID=<Access key ID obtained in step 12>
export AWS_SECRET_ACCESS_KEY=<Access secret key obyained in step 12>
export AWS_ACCOUNT_ID=<Copy the account id obtained in step 13>
export AWS_DEFAULT_REGION=<See step 14>
```

## Create KMS key

Pick some alias for the key, define the AWS region name
```bash
export VALIDATOR_KEY_ALIAS=<validator signer key alias>
```

Create the signing key using aws cli:
```bash
> ./aws/create_kms_signing_key.sh
 Signing key created correctly
 {
    "KeyMetadata": {
        "AWSAccountId": "861012453243",
        "KeyId": "b661293a-6ead-452b-86e2-401c1d841e4e",
        "Arn": "arn:aws:kms:us-east-1:861012453243:key/b661293a-6ead-452b-86e2-401c1d841e4e",
        "CreationDate": "2025-02-26T14:42:10.458000-03:00",
        "Enabled": true,
        "Description": "",
        "KeyUsage": "SIGN_VERIFY",
        "KeyState": "Enabled",
        "Origin": "AWS_KMS",
        "KeyManager": "CUSTOMER",
        "CustomerMasterKeySpec": "ECC_SECG_P256K1",
        "KeySpec": "ECC_SECG_P256K1",
        "SigningAlgorithms": [
            "ECDSA_SHA_256"
        ],
        "MultiRegion": false
    }
}
```

Update some environment variables.

```bash
export AWS_KMS_KEY_ID=alias/$VALIDATOR_KEY_ALIAS
export VALIDATOR_ADDRESS=`cast wallet address --aws`
```

## Generate the S3 bucket

Create the bucket and configure the policy of the bucket.
```
> export VALIDATOR_BUCKET_NAME=<pick a bucket name>
> ./aws/create_bucket.sh 
```

# Initialize the chains with the Hyperlane contracts
(Reference: https://docs.hyperlane.xyz/docs/guides/local-testnet-setup)

First delete the filesystem registry in case you already deployed some Hyperlane contracts locally:
```bash
rm -Rf ~/.hyperlane/*
```

Open new terminal and launch the source chain:
```bash
./launch_source_chain
```

Open new terminal and launch the destination chain:
```bash
./launch_destination_chain
```

Open a new terminal.
Note that the  `HYP_KEY` environment variable is set in the hookShell of nix to the first private key generated by Anvil.
This key will be used to deploy the Hyperlane contracts.

*TODO:* automate answering to the questions.

Register the chains before Hyperlane can deploy its contracts.

First the source chain:
```bash
> hyperlane registry init

? Detected rpc url as http://localhost:8545 from JSON RPC provider, is this
correct? [PUSH ENTER]
? Enter chain name (one word, lower case) source
? Enter chain display name (Source) [PUSH ENTER]
? Detected chain id as 31337 from JSON RPC provider, is this correct? (Y/n) [PUSH ENTER]
? Is this chain a testnet (a chain used for testing & development)? (Y/n) [PUSH ENTER]
? Select the chain technical stack (Use arrow keys) [PUSH ENTER]
? Detected starting block number for indexing as 30 from JSON RPC provider, is
this correct? (Y/n) [PUSH ENTER]
? Do you want to add a block explorer config for this chain (y/N) [PUSH ENTER]
? Do you want to set block or gas properties for this chain config (y/N) [PUSH ENTER]
? Do you want to set native token properties for this chain config (defaults to 
ETH) (y/N) [PUSH ENTER]
```

Then the destination chain:
```bash
> hyperlane registry init
? Detected rpc url as http://localhost:8545 from JSON RPC provider, is this
correct? n
? Enter http or https rpc url: (http://localhost:8545) http://localhost:8546
? Enter chain name (one word, lower case) destination
? Enter chain display name (Destination) [PUSH ENTER]
? Detected chain id as 31337 from JSON RPC provider, is this correct? (Y/n) [PUSH ENTER]
? Is this chain a testnet (a chain used for testing & development)? (Y/n) [PUSH ENTER]
? Select the chain technical stack (Use arrow keys) [PUSH ENTER]
? Detected starting block number for indexing as 30 from JSON RPC provider, is
this correct? (Y/n) [PUSH ENTER]
? Do you want to add a block explorer config for this chain (y/N) [PUSH ENTER]
? Do you want to set block or gas properties for this chain config (y/N) [PUSH ENTER]
? Do you want to set native token properties for this chain config (defaults to
ETH) (y/N) [PUSH ENTER]
```

Note that it is not necessary to initialize the configuration of the core contracts because it is already hardcoded in configs/core-config.yaml.
However, this file depends on the validator's address and thus needs to be generated with the following command:

```
> ./create_contracts_config.sh
OK
```

Note that this configuration considers a default ISM using a multisig of a single signer. 

Deploy the Hyperlane contracts on the source chain.
```bash
> hyperlane core deploy -o configs/core-config.yaml 
? Select network type (Use arrow keys) [PICK Testnet]
? Select chain to connect: [TYPE source]
? Do you want to use an API key to verify on this (source) chain's block 
explorer (y/N) [PUSH ENTER]
? Is this deployment plan correct? (Y/n) [PUSH ENTER]
```

Deploy the Hyperlane contracts on the destination chain.
```bash
> hyperlane core deploy -o configs/core-config.yaml
? Select network type (Use arrow keys) [PICK Testnet]
? Select chain to connect: [TYPE destination]
? Do you want to use an API key to verify on this (source) chain's block 
explorer (y/N) [PUSH ENTER]
? Is this deployment plan correct? (Y/n) [PUSH ENTER]
```

# Spin up a validator and a relayer

(Reference: https://docs.hyperlane.xyz/docs/operate/docker-quickstart#4-setup-validator-environment)

Send the validator some ethers from the first private key generated by anvil. Recall the validator address was generated above.
```bash
> cast send  $VALIDATOR_ADDRESS --value 1ether --private-key $HYP_KEY
```

Create the validator configuration file. Be sure all the environment variables mentioned above are correctly set. 
```
> ./create_validator_config.sh
OK
```

Launch the validator docker
```bash
> docker compose --env-file .env.source up source-validator -d
```

Check everything works, that is there are no ugly error messages.
```bash
> docker logs -f source-validator 
```

Send the relayer some ethers on the *destination chain**.
Note the validator and relayer use the same address. TODO change this at some point.

```
> cast send  $VALIDATOR_ADDRESS --value 1ether --private-key $HYP_KEY --rpc-url http://localhost:8546
```

Launch the relayer docker.
```bash
> docker compose --env-file .env.source up relayer -d
```

Check everything works, that is there are no ugly error messages.
```bash
> docker logs -f relayer 
```

# Send a test message between two chains

Send a test message from the source chain to the destination chain.
```bash
> hyperlane send message
```

# References

[Configuration reference](https://docs.hyperlane.xyz/docs/operate/config-reference)
